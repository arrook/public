# 物联网疗养系统的核心流程图、时序图、 ER 图（实体关系图）

---

## ✅ 1. 系统架构图（Mermaid）

```mermaid
graph LR
    A[Vue3 前端] <-->|WebSocket / HTTP| B[FastAPI 后端]
    B <-->|MQTT| C[EMQX MQTT Broker]
    C <-->|MQTT over WiFi| D[STM32 边缘设备]
    D <-->|I²C/GPIO/UART| E[传感器与执行器]

    style A fill:#e1f5fe
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D fill:#e8f5e9
    style E fill:#fce4ec
```

---

## ✅ 2. 数据流程图（Mermaid）

```mermaid
flowchart LR
    S[传感器层] -->|采集数据| E[边缘设备]
    E -->|发布MQTT| M[MQTT Broker]
    M -->|存储| DB[(MySQL)]
    DB -->|查询| API[FastAPI]
    API <-->|WebSocket| F[Vue前端]

    F -->|控制指令| API
    API -->|下发配置| M
    M -->|控制命令| E
    E -->|执行控制| A[执行器]
```

---

## ✅ 3. 用户登录时序图（Mermaid）

```mermaid
sequenceDiagram
    participant U as 用户
    participant V as Vue前端
    participant A as FastAPI
    participant D as 数据库
    participant M as MQTT Broker

    U->>V: 输入凭据
    V->>A: POST /auth/login
    A->>D: 验证用户
    D-->>A: 返回用户信息
    A-->>V: 返回JWT Token
    V->>M: 建立WebSocket连接
    V->>M: 订阅主题 /topic/realtime/*
    V-->>U: 登录成功
```

---

## ✅ 4. 实时数据采集与推送时序图

```mermaid
sequenceDiagram
    participant S as 传感器
    participant D as STM32设备
    participant M as MQTT Broker
    participant A as FastAPI
    participant DB as 数据库
    participant V as Vue前端

    S->>D: 采集数据
    D->>D: 数据预处理
    D->>M: 发布MQTT消息
    M->>A: 接收MQTT消息
    A->>DB: 保存数据
    A->>A: 检查报警规则
    A->>V: WebSocket推送
    V->>V: 更新界面
```

---

## ✅ 5. 设备控制时序图

```mermaid
sequenceDiagram
    participant Doc as 医生
    participant V as Vue前端
    participant A as FastAPI
    participant M as MQTT Broker
    participant D as STM32设备
    participant Act as 执行器

    Doc->>V: 点击控制按钮
    V->>A: PUT /config/device_001
    A->>A: 验证权限
    A->>M: 发布控制命令
    M->>D: 接收命令
    D->>Act: 控制执行器
    Act-->>D: 执行结果
    D->>M: 状态确认
    M-->>A: 状态确认
    A-->>V: 推送状态
    V-->>Doc: 显示结果
```

---

## ✅ 6. 报警处理时序图

```mermaid
sequenceDiagram
    participant N as 护理员
    participant V as Vue前端
    participant A as FastAPI
    participant DB as 数据库
    participant M as MQTT Broker
    participant E as 邮件服务

    M-->>V: 实时报警推送
    V-->>N: 显示报警
    N->>V: 查看报警列表
    V->>A: GET /alerts
    A->>DB: 查询报警记录
    DB-->>A: 返回数据
    A-->>V: 显示列表
    N->>V: 处理报警
    V->>A: PUT /alerts/{id}/handle
    A->>DB: 更新状态
    A->>E: 发送邮件通知
    A-->>V: 返回结果
    V-->>N: 显示处理结果
```

---

## ✅ 7. ER 图（实体关系图）

```mermaid
erDiagram
    USER {
        int id PK
        string username UK
        string email UK
        string hashed_password
        string full_name
        string role
        boolean is_active
        datetime created_at
    }

    USERDEVICE {
        int id PK
        int user_id FK
        string device_name
        string device_name
        boolean is_bound
        datetime bound_at
    }

    DEVICEDATA {
        int id PK
        string device_name
        datetime timestamp
        int heart_rate
        int blood_oxygen
        int systolic_pressure
        int diastolic_pressure
        float body_temperature
        float env_temperature
        int env_humidity
        int smoke_level
        float acceleration_x
        float acceleration_y
        float acceleration_z
        boolean fall_detected
        int pillbox_status
    }

    ALERT {
        int id PK
        string device_name
        int user_id FK
        string alert_type
        string alert_message
        float alert_value
        float threshold
        string severity
        boolean is_handled
        int handled_by FK
        datetime handled_at
        datetime created_at
    }

    SYSTEMCONFIG {
        int id PK
        string device_name UK
        json config_data
        datetime updated_at
        int updated_by FK
    }

    USER ||--o{ USERDEVICE : has
    USER ||--o{ ALERT : triggers
    USER ||--o{ SYSTEMCONFIG : updates
    ALERT }o--|| USER : handled_by
```
